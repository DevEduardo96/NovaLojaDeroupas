
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Checkout Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Teste Checkout Debug</h1>
    <button onclick="testInsert()">Testar Inser√ß√£o Direta</button>
    <button onclick="testAuth()">Verificar Autentica√ß√£o</button>
    <div id="output"></div>

    <script>
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://zsceradvdzzhqynfnchh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzY2VyYWR2ZHp6aHF5bmZuY2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTY0NjIsImV4cCI6MjA3MDMzMjQ2Mn0.9OFPKkSVYqpbdxb15c8QOlkgIAb73E-QQTmq1YrNaOI';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<div>' + message + '</div>';
            console.log(message);
        }
        
        async function testAuth() {
            log('üîç Verificando autentica√ß√£o...');
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error) {
                log('‚ùå Erro na autentica√ß√£o: ' + error.message);
            } else {
                log('üë§ Usu√°rio: ' + (user ? user.email : 'N√£o autenticado'));
            }
        }
        
        async function testInsert() {
            document.getElementById('output').innerHTML = '';
            log('üß™ Iniciando teste de inser√ß√£o...');
            
            try {
                // 1. Verificar acesso √† tabela
                log('1Ô∏è‚É£ Testando acesso √† tabela pedidos...');
                const { data: tableTest, error: tableError } = await supabase
                    .from('pedidos')
                    .select('id')
                    .limit(1);
                
                if (tableError) {
                    log('‚ùå Erro ao acessar tabela: ' + JSON.stringify(tableError));
                    return;
                }
                
                log('‚úÖ Tabela acess√≠vel');
                
                // 2. Verificar usu√°rio
                const { data: { user } } = await supabase.auth.getUser();
                log('üë§ Usu√°rio: ' + (user ? user.email : 'N√£o autenticado'));
                
                // 3. Inserir dados
                const testData = {
                    user_id: user?.id || null,
                    email_cliente: 'teste-debug@exemplo.com',
                    nome_cliente: 'Teste Debug HTML',
                    telefone: '11999999999',
                    subtotal: 15.00,
                    total: 15.00,
                    status: 'pendente',
                    metodo_pagamento: 'pix'
                };
                
                log('2Ô∏è‚É£ Inserindo dados: ' + JSON.stringify(testData));
                
                const { data: insertResult, error: insertError } = await supabase
                    .from('pedidos')
                    .insert(testData)
                    .select()
                    .single();
                
                if (insertError) {
                    log('‚ùå ERRO NA INSER√á√ÉO: ' + JSON.stringify(insertError));
                    if (insertError.code === '42501') {
                        log('üö® PROBLEMA RLS: Execute sql/policies_rls_pedidos.sql');
                    }
                    return;
                }
                
                log('‚úÖ SUCESSO! Pedido criado: ' + JSON.stringify(insertResult));
                
                // 4. Limpeza
                await supabase.from('pedidos').delete().eq('id', insertResult.id);
                log('üßπ Teste removido');
                
            } catch (error) {
                log('üí• ERRO GERAL: ' + error.message);
            }
        }
    </script>
</body>
</html>
